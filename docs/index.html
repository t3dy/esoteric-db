<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esoteric Studies Database</title>
    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Insights -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cytoscape.js for Graph -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <!-- WordCloud2.js for Word Cloud -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        #cy {
            width: 100%;
            height: 600px;
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans" x-data="app()">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-indigo-600">Esoteric DB</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a @click.prevent="activeTab = 'browse'" href="#"
                    :class="activeTab === 'browse' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Browse
                </a>
                <a @click.prevent="activeTab = 'library'" href="#"
                    :class="activeTab === 'library' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Library
                </a>
                <a @click.prevent="activeTab = 'insights'" href="#"
                    :class="activeTab === 'insights' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Insights
                </a>
                <a @click.prevent="activeTab = 'search'" href="#"
                    :class="activeTab === 'search' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Search <span class="ml-1 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs">Full
                        Text</span>
                </a>
                <a @click.prevent="activeTab = 'graph'" href="#"
                    :class="activeTab === 'graph' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Graph <span class="ml-1 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs">Knowledge</span>
                </a>
            </nav>
        </div>

        <!-- Browse Tab -->
        <div x-show="activeTab === 'browse'" x-cloak>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Movement Categories -->
                <div class="bg-white p-4 rounded shadow border-l-4 border-indigo-500 hover:shadow-md transition cursor-pointer"
                    @click="browseCategory('Topics')">
                    <h3 class="font-bold text-gray-900">Movements</h3>
                    <p class="text-xs text-gray-500" x-text="`${statsData?.topics?.length || 0} Topics`"></p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-500 hover:shadow-md transition cursor-pointer"
                    @click="browseCategory('Authors')">
                    <h3 class="font-bold text-gray-900">Authors</h3>
                    <p class="text-xs text-gray-500" x-text="`${statsData?.authors?.length || 0} Names`"></p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500 hover:shadow-md transition cursor-pointer"
                    @click="browseCategory('Figures')">
                    <h3 class="font-bold text-gray-900">Historical Figures</h3>
                    <p class="text-xs text-gray-500" x-text="`${listsData?.figures?.length || 0} Entities`"></p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-red-500 hover:shadow-md transition cursor-pointer"
                    @click="browseCategory('Scholars')">
                    <h3 class="font-bold text-gray-900">Scholars</h3>
                    <p class="text-xs text-gray-500" x-text="`${listsData?.scholars?.length || 0} Names`"></p>
                </div>
            </div>

            <!-- Category Detail (Simple list) -->
            <div x-show="browsingCategory" class="bg-white p-6 rounded shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" x-text="browsingCategory"></h2>
                    <button @click="browsingCategory = null" class="text-xs text-gray-500 hover:underline">Back to
                        categories</button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="item in currentCategoryList" :key="item">
                        <button @click="openDashboard(item, browsingCategory)"
                            class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition" x-text="item">
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Topic Dashboard (Overlay/Full Page) -->
        <div x-show="activeDashboard" x-cloak class="fixed inset-0 bg-white z-50 overflow-y-auto p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8 border-b pb-4">
                    <div>
                        <span class="text-xs font-bold text-indigo-500 uppercase tracking-widest"
                            x-text="dashboardType"></span>
                        <h1 class="text-4xl font-black text-gray-900" x-text="activeDashboard"></h1>
                    </div>
                    <button @click="activeDashboard = null" class="px-4 py-2 border rounded hover:bg-gray-50">Close
                        Dashboard</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Dashboard Sidebar: Connections -->
                    <div class="space-y-6">
                        <div class="bg-white border rounded p-4">
                            <h3 class="font-bold mb-2">Related Entities</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="fig in listsData?.figures?.slice(0, 5)">
                                    <span class="px-2 py-1 bg-green-50 text-green-700 text-xs rounded"
                                        x-text="fig"></span>
                                </template>
                            </div>
                        </div>
                        <div class="bg-white border rounded p-4">
                            <h3 class="font-bold mb-2">Primary Texts</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <template x-for="txt in listsData?.texts?.slice(0, 3)">
                                    <li class="flex items-center">
                                        <svg class="w-3 h-3 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M9 4.804A7.994 7.994 0 0111 4c1.065 0 2.09.208 3.027.589A3.38 3.38 0 0115 7.5a3.38 3.38 0 01-1.006 2.378c-.5.5-.326 1.343.326 1.343 0 0 1.25.125 1.25 1.25s-1.25 1.25-1.25 1.25c-.652 0-.827.843-.326 1.343A3.38 3.38 0 0115 17.5a3.38 3.38 0 01-1.027 2.411A7.994 7.994 0 0111 20c-1.065 0-2.09-.208-3.027-.589A3.38 3.38 0 017 17a3.38 3.38 0 011.006-2.378c.5-.5.326-1.343-.326-1.343 0 0-1.25-.125-1.25-1.25s1.25-1.25 1.25-1.25c.652 0 .827-.843.326-1.343A3.38 3.38 0 017 7.5a3.38 3.38 0 011.027-2.411A7.994 7.994 0 0111 4c1.065 0 2.09.208 3.027.589">
                                            </path>
                                        </svg>
                                        <span x-text="txt"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>

                    <!-- Dashboard Main: Documents -->
                    <div class="lg:col-span-2">
                        <h3 class="text-xl font-bold mb-4">Documents in this Movement</h3>
                        <div class="space-y-4">
                            <template x-for="doc in dashboardDocs" :key="doc.id">
                                <div
                                    class="bg-gray-50 p-4 rounded flex justify-between items-center border hover:border-indigo-200 transition">
                                    <div>
                                        <div class="font-medium text-gray-900" x-text="doc.filename"></div>
                                        <div class="text-sm text-gray-500" x-text="doc.author"></div>
                                    </div>
                                    <span class="text-xs text-indigo-600 font-mono" x-text="doc.period"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Library -->
        <div x-show="activeTab === 'library'" x-cloak>
            <div class="mb-4">
                <input type="text" x-model="searchQuery" placeholder="Filter by title..."
                    class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border">
            </div>
            <div class="flex flex-col">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Title / Filename
                                        </th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Topic
                                        </th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Size
                                        </th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Added
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="doc in filteredDocs" :key="doc.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="ml-4">
                                                        <div class="text-sm font-medium text-gray-900"
                                                            x-text="doc.filename"></div>
                                                        <div class="text-sm text-gray-500" x-text="doc.path"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span
                                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
                                                    x-text="doc.topic">
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                x-text="formatBytes(doc.size)">
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                x-text="new Date(doc.created_at).toLocaleDateString()">
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <div x-show="filteredDocs.length === 0" class="p-4 text-center text-gray-500">
                                No documents found.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Insights -->
        <!-- Tab Content: Insights -->
        <div x-show="activeTab === 'insights'" x-cloak>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Topic Distribution -->
                <div class="bg-white overflow-hidden shadow rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Topic Distribution</h3>
                    <div class="relative h-64">
                        <canvas id="topicChart"></canvas>
                    </div>
                </div>

                <!-- Word Cloud -->
                <div class="bg-white overflow-hidden shadow rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Key Concepts</h3>
                    <div class="relative h-64 bg-gray-50 rounded border flex items-center justify-center">
                        <canvas id="wordCloudCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="bg-white overflow-hidden shadow rounded-lg p-4 col-span-1 md:col-span-2">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Library Growth Over Time</h3>
                    <div class="relative h-64">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Search -->
        <div x-show="activeTab === 'search'" x-cloak>
            <div class="mb-4">
                <input type="text" x-model="fullTextQuery" placeholder="Search unside documents..."
                    class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border">
            </div>

            <div x-show="!config.features?.search" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-sm text-yellow-700">Search is disabled in config.json.</p>
            </div>

            <div x-show="config.features?.search && fullTextQuery.length > 2">
                <p class="text-sm text-gray-500 mb-2" x-text="`Found ${searchResults.length} matches`"></p>
                <div class="space-y-4">
                    <template x-for="result in searchResults" :key="result.id">
                        <div class="bg-white shadow sm:rounded-lg p-4 transition hover:shadow-md">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg leading-6 font-medium text-gray-900"
                                    x-text="result.id.startsWith('qa_') ? 'Chat Q&A' : result.filename"></h3>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                    :class="result.id.startsWith('qa_') ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'"
                                    x-text="result.id.startsWith('qa_') ? 'Exchange' : 'Document'">
                                </span>
                            </div>

                            <!-- Document Path -->
                            <p x-show="!result.id.startsWith('qa_')" class="text-sm text-gray-500 mt-1"
                                x-text="result.path"></p>

                            <!-- Content Snippet -->
                            <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded prose prose-sm max-w-none">
                                <span x-html="highlight(result.snippet, fullTextQuery)"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div x-show="config.features?.search && fullTextQuery.length <= 2" class="text-center text-gray-500 mt-10">
                Type at least 3 characters to search document contents.
            </div>
        </div>

        <!-- Tab Content: Graph -->
        <div x-show="activeTab === 'graph'" x-cloak>
            <div x-show="!config.features?.graph" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-sm text-yellow-700">Graph is disabled in config.json.</p>
            </div>

            <div x-show="config.features?.graph">
                <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                    <div id="cy" class="w-full h-[700px] bg-gray-50"></div>
                </div>
                <div
                    class="mt-4 flex justify-between items-center text-xs text-gray-500 bg-white p-3 rounded border shadow-sm">
                    <div class="flex gap-4">
                        <span class="flex items-center"><span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                            Movement (Topic)</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            Entity (Figure/Scholar)</span>
                    </div>
                    <p>Zoom to explore connections. Scroll to zoom, drag nodes to organize.</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Chat -->
        <div x-show="activeTab === 'chat'" x-cloak>
            <div x-show="!config.features?.chat" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-sm text-yellow-700">Chat is disabled in config.json.</p>
            </div>

            <div x-show="config.features?.chat" class="flex h-[600px] border rounded bg-white shadow overflow-hidden">
                <!-- Sidebar: Chat List -->
                <div class="w-1/3 border-r bg-gray-50 overflow-y-auto">
                    <template x-for="chat in chats" :key="chat.id">
                        <div @click="activeChat = chat"
                            :class="activeChat?.id === chat.id ? 'bg-indigo-50 border-l-4 border-indigo-500' : 'hover:bg-gray-100 border-l-4 border-transparent'"
                            class="p-4 cursor-pointer border-b transition">
                            <h3 class="text-sm font-medium text-gray-900" x-text="chat.title"></h3>
                            <p class="text-xs text-gray-500 mt-1" x-text="new Date(chat.date).toLocaleDateString()"></p>
                        </div>
                    </template>
                </div>

                <!-- Main: Message View -->
                <div class="w-2/3 flex flex-col">
                    <div x-show="!activeChat" class="flex-1 flex items-center justify-center text-gray-400">
                        Select a chat to view log.
                    </div>
                    <div x-show="activeChat" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <template x-for="msg in activeChat?.messages" :key="msg.ordinal">
                            <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                <div :class="msg.role === 'user' ? 'bg-indigo-100 text-indigo-900' : 'bg-gray-100 text-gray-900'"
                                    class="max-w-3/4 rounded-lg px-4 py-2 text-sm shadow-sm">
                                    <span class="block text-xs font-bold mb-1 opacity-50" x-text="msg.role"></span>
                                    <div x-text="msg.content"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        function app() {
            return {
                activeTab: 'browse',
                docs: [],
                chats: [],
                listsData: null,
                activeChat: null,
                statsData: null,
                renderedInsights: false,
                searchIndex: {},
                searchQuery: '',
                fullTextQuery: '',
                config: {},
                cy: null,

                // New State for Browsing & Dashboards
                browsingCategory: null,
                activeDashboard: null,
                dashboardType: null,

                get currentCategoryList() {
                    if (!this.browsingCategory) return [];
                    if (this.browsingCategory === 'Topics') return this.statsData?.topics?.map(t => t.label) || [];
                    if (this.browsingCategory === 'Authors') return this.statsData?.authors || [];
                    if (this.browsingCategory === 'Figures') return this.listsData?.figures || [];
                    if (this.browsingCategory === 'Scholars') return this.listsData?.scholars || [];
                    return [];
                },

                get dashboardDocs() {
                    if (!this.activeDashboard) return [];
                    const q = this.activeDashboard.toLowerCase();
                    if (this.dashboardType === 'Topics') return this.docs.filter(d => d.topic.toLowerCase() === q);
                    if (this.dashboardType === 'Authors') return this.docs.filter(d => d.author.toLowerCase() === q);
                    // For figures/scholars, we'd filter by 'MENTIONS' in a real setup.
                    // For now, return a slice of the library to demo the UI.
                    return this.docs.slice(0, 10);
                },

                browseCategory(cat) {
                    this.browsingCategory = cat;
                },

                openDashboard(item, type) {
                    this.activeDashboard = item;
                    this.dashboardType = type;
                },

                get filteredDocs() {
                    if (this.searchQuery === '') return this.docs;
                    return this.docs.filter(doc => {
                        return doc.filename.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                            doc.topic.toLowerCase().includes(this.searchQuery.toLowerCase());
                    });
                },

                get searchResults() {
                    if (!this.fullTextQuery || this.fullTextQuery.length <= 2) return [];
                    const q = this.fullTextQuery.toLowerCase();

                    // Find docs where the search index contains the query
                    const results = [];
                    for (const [docId, text] of Object.entries(this.searchIndex)) {
                        if (text.toLowerCase().includes(q)) {
                            // Is it a Doc or a Q&A?
                            if (docId.startsWith('qa_')) {
                                // Q&A Result
                                // We don't have metadata in `this.docs` for these.
                                // We construct a result object directly.
                                const idx = text.toLowerCase().indexOf(q);
                                const start = Math.max(0, idx - 40);
                                const end = Math.min(text.length, idx + 80);
                                const snippet = text.substring(start, end);

                                results.push({
                                    id: docId,
                                    filename: 'Chat Exchange',
                                    path: 'Linked to Topic',
                                    snippet: snippet
                                });
                            } else {
                                // Document Result
                                const doc = this.docs.find(d => d.id === docId);
                                if (doc) {
                                    // Extract snippet
                                    const idx = text.toLowerCase().indexOf(q);
                                    const start = Math.max(0, idx - 40);
                                    const end = Math.min(text.length, idx + 80);
                                    const snippet = text.substring(start, end);
                                    results.push({ ...doc, snippet });
                                }
                            }
                        }
                    }
                    return results.slice(0, 50); // Limit results
                },

                highlight(text, query) {
                    if (!query) return text;
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.replace(regex, '<mark>$1</mark>');
                },

                formatBytes(bytes, decimals = 2) {
                    if (!+bytes) return '0 Bytes';
                    const k = 1024, dm = decimals < 0 ? 0 : decimals,
                        sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                        i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
                },

                async init() {
                    console.log("Initializing App...");

                    try {
                        // Load Config
                        const configRes = await fetch('config.json');
                        if (configRes.ok) this.config = await configRes.json();

                        // Load Docs
                        const docsRes = await fetch('docs.json');
                        if (docsRes.ok) this.docs = await docsRes.json();

                        // Load Stats
                        const statsRes = await fetch('stats.json');
                        if (statsRes.ok) {
                            this.statsData = await statsRes.json();
                        }

                        // Load Categorical Lists (User Request)
                        const listsRes = await fetch('lists.json');
                        if (listsRes.ok) {
                            this.listsData = await listsRes.json();
                        }

                        this.$watch('activeTab', val => {
                            if (val === 'insights' && !this.renderedInsights && this.statsData) {
                                this.$nextTick(() => {
                                    this.renderCharts(this.statsData);
                                    this.renderedInsights = true;
                                });
                            }
                        });

                        // Load Search Index (Lazy load if active?)
                        if (this.config.features?.search) {
                            const searchRes = await fetch('search.json');
                            if (searchRes.ok) this.searchIndex = await searchRes.json();
                        }

                        if (this.config.features?.graph) {
                            const graphRes = await fetch('graph.json');
                            if (graphRes.ok) {
                                const graphData = await graphRes.json();
                                // Initialize Cytoscape when tab is clicked
                                this.$watch('activeTab', value => {
                                    if (value === 'graph' && !this.cy) {
                                        this.$nextTick(() => this.renderGraph(graphData));
                                    }
                                });
                            }
                        }

                        if (this.config.features?.chat) {
                            const chatRes = await fetch('chats.json');
                            if (chatRes.ok) {
                                this.chats = await chatRes.json();
                                if (this.chats.length > 0) this.activeChat = this.chats[0];
                            }
                        }

                    } catch (e) {
                        console.error("Error loading data:", e);
                    }
                },

                renderCharts(stats) {
                    // 1. Topic Doughnut
                    const ctxTopic = document.getElementById('topicChart').getContext('2d');
                    new Chart(ctxTopic, {
                        type: 'doughnut',
                        data: {
                            labels: stats.topics.map(s => s.label),
                            datasets: [{
                                data: stats.topics.map(s => s.value),
                                backgroundColor: [
                                    '#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right' } }
                        }
                    });

                    // 2. Timeline Line Chart
                    const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
                    new Chart(ctxTimeline, {
                        type: 'line',
                        data: {
                            labels: stats.timeline.map(s => s.label),
                            datasets: [{
                                label: 'Documents Added',
                                data: stats.timeline.map(s => s.value),
                                borderColor: '#4F46E5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });

                    // 3. Word Cloud
                    const canvas = document.getElementById('wordCloudCanvas');
                    // Resize canvas to parent
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;

                    WordCloud(canvas, {
                        list: stats.wordcloud.map(x => [x.word, x.weight]),
                        gridSize: 8,
                        weightFactor: (size) => Math.log(size + 1) * 15, // Log scale for better fit
                        fontFamily: 'sans-serif',
                        color: 'random-dark',
                        rotateRatio: 0.5,
                        backgroundColor: 'transparent'
                    });
                },

                renderGraph(data) {
                    const elements = data.elements || data;
                    console.log("Rendering Graph with", elements.nodes?.length, "nodes");

                    this.cy = cytoscape({
                        container: document.getElementById('cy'),
                        elements: elements,
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'label': 'data(label)',
                                    'font-size': '10px',
                                    'color': '#374151', // gray-700
                                    'text-valign': 'center',
                                    'text-halign': 'right',
                                    'background-color': '#9CA3AF', // gray-400
                                    'width': 'data(size)',
                                    'height': 'data(size)',
                                    'text-margin-x': 5
                                }
                            },
                            {
                                selector: 'node[type="topic"]',
                                style: {
                                    'background-color': '#6366F1', // indigo-500
                                    'font-weight': 'bold',
                                    'text-halign': 'center'
                                }
                            },
                            {
                                selector: 'node[type="entity"]',
                                style: {
                                    'background-color': '#10B981', // green-500
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 'data(weight) || 1',
                                    'line-color': '#E5E7EB', // gray-200
                                    'curve-style': 'bezier',
                                    'opacity': 0.6
                                }
                            }
                        ],
                        layout: {
                            name: 'cose',
                            animate: true,
                            randomize: true,
                            padding: 30,
                            nodeRepulsion: 4000
                        }
                    });
                }
            }
        }
    </script>
</body>

</html>