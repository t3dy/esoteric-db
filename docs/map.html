<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esoteric DB - Hermetic Atlas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="assets/omni_search.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .serif {
            font-family: 'Cinzel', serif;
        }

        /* Drawer */
        #city-drawer {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }

        #city-drawer.open {
            transform: translateX(0);
        }

        /* Map Styles */
        .map-bg {
            fill: #1e293b;
            stroke: #334155;
            stroke-width: 0.5;
        }

        .city-node {
            fill: #10b981;
            cursor: pointer;
            transition: all 0.3s;
        }

        .city-node:hover {
            fill: #34d399;
            r: 8;
            stroke: rgba(16, 185, 129, 0.4);
            stroke-width: 8px;
        }

        .city-label {
            font-size: 10px;
            fill: #94a3b8;
            font-weight: 600;
            pointer-events: none;
            text-shadow: 0 2px 4px #0f172a;
        }

        /* Pulse Animation */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
                opacity: 1;
            }

            80%,
            100% {
                opacity: 0;
            }
        }

        .pulse-circle {
            animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            transform-origin: center;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- Header -->
    <header
        class="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-8 py-4 flex items-center justify-between z-20 absolute w-full top-0">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2 text-white">
                <span class="text-emerald-500">üåç</span> The Hermetic Atlas
            </h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">Geography of Transmission</p>

            <!-- Global Nav -->
            <div class="hidden md:flex items-center gap-1 mt-2 border-l border-slate-700 pl-4">
                <a href="index.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-emerald-500 hover:text-white transition">Hub</a>
                <a href="alchemy.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white transition">Alchemy</a>
                <a href="hermetic.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white transition">Hermetic</a>
                <a href="library.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white transition">Library</a>
                <a href="tables.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white transition">Tables</a>
                <a href="entities.html"
                    class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white transition">Entities</a>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="window.dispatchEvent(new KeyboardEvent('keydown', {ctrlKey: true, key: 'k'}))"
                class="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 text-[10px] font-black hover:bg-slate-700 transition">
                SEARCH <span class="ml-2 border border-slate-600 px-1 rounded text-[9px]">CTRL K</span>
            </button>
        </div>
    </header>

    <!-- Main Map Container -->
    <div id="map-container" class="flex-1 w-full h-full bg-[#020617] relative">
        <svg id="main-svg" class="w-full h-full"></svg>

        <!-- Loading Overlay -->
        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-slate-900 z-50">
            <div class="text-center">
                <div class="text-4xl animate-bounce mb-4">üó∫Ô∏è</div>
                <div class="text-emerald-500 font-mono text-xs uppercase tracking-[0.2em] animate-pulse">Triangulating
                    Esoteric Centers...</div>
            </div>
        </div>

        <!-- Time Slider -->
        <div
            class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/90 border border-slate-700 p-4 rounded-2xl flex flex-col items-center gap-2 shadow-2xl w-96 backdrop-blur">
            <div class="flex justify-between w-full text-[10px] font-black uppercase text-slate-500 tracking-widest">
                <span>Antiquity</span>
                <span>Medieval</span>
                <span>Renaissan</span>
                <span>Enlighten</span>
            </div>
            <input type="range" min="0" max="3" value="3" step="1" id="time-slider"
                class="w-full accent-emerald-500 cursor-pointer" oninput="filterEra(this.value)">
            <div id="era-label" class="text-xs font-bold text-emerald-400 serif">ALL ERAS</div>
        </div>

        <!-- Zoom Controls -->
        <div class="absolute bottom-8 right-8 flex flex-col gap-2">
            <button onclick="zoomMap(1.5)"
                class="p-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 border border-slate-700 font-bold shadow-lg transition active:scale-95">+</button>
            <button onclick="zoomMap(0.6)"
                class="p-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 border border-slate-700 font-bold shadow-lg transition active:scale-95">-</button>
        </div>
    </div>

    <!-- Right Drawer -->
    <aside id="city-drawer"
        class="w-[400px] bg-slate-900 border-l border-slate-800 shadow-2xl z-30 overflow-y-auto flex flex-col p-8 fixed right-0 top-0 h-full">
        <div class="flex justify-between items-start mb-8">
            <button onclick="closeDrawer()" class="text-slate-400 hover:text-white transition text-2xl">√ó</button>
            <span
                class="text-[10px] font-bold text-emerald-500 border border-emerald-900/50 bg-emerald-900/20 px-2 py-1 rounded">GENIUS
                LOCI</span>
        </div>
        <div id="drawer-content" class="space-y-8">
            <!-- Content Injected Here -->
        </div>
    </aside>

    <script>
        let width = window.innerWidth;
        let height = window.innerHeight;
        let svg = d3.select("#main-svg");
        let g = svg.append("g");
        let zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", (e) => g.attr("transform", e.transform));

        svg.call(zoom);

        // Projection
        let projection = d3.geoMercator()
            .center([15, 48])
            .scale(width / 1.5)
            .translate([width / 2, height / 2]);

        let path = d3.geoPath().projection(projection);
        let allPlaces = [];
        const eras = ["Antiquity", "Medieval", "Renaissance", "Enlightenment"];

        async function init() {
            try {
                // 1. Try to fetch world map (optional)
                try {
                    const res = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                    if (res.ok) {
                        // In a real scenario we'd use topojson here.
                        // For now we rely on the aesthetic of the "Star Chart" (Points only)
                    }
                } catch (e) { }

                // 2. Load Places
                const pRes = await fetch('places.json');
                const pData = await pRes.json();
                allPlaces = pData.features;

                document.getElementById('loader').classList.add('hidden');

                renderMap(allPlaces);

            } catch (e) {
                console.error(e);
                document.getElementById('map-container').innerHTML = `<div class="p-20 text-center text-slate-500">Map Data Offline. Run <code>python scripts/build_atlas.py</code></div>`;
            }
        }

        function renderMap(features) {
            // Bind Data (Keyed by name to ensure stable transitions)
            const nodes = g.selectAll(".city-node").data(features, d => d.properties.name);
            const labels = g.selectAll(".city-label").data(features, d => d.properties.name);

            // EXIT
            nodes.exit()
                .transition().duration(500)
                .attr("r", 0)
                .style("opacity", 0)
                .remove();

            labels.exit()
                .transition().duration(500)
                .style("opacity", 0)
                .remove();

            // ENTER
            const nodesEnter = nodes.enter()
                .append("circle")
                .attr("cx", d => projection(d.geometry.coordinates)[0])
                .attr("cy", d => projection(d.geometry.coordinates)[1])
                .attr("r", 0)
                .attr("class", "city-node")
                .on("click", (e, d) => openCity(d.properties));

            const labelsEnter = labels.enter()
                .append("text")
                .attr("x", d => projection(d.geometry.coordinates)[0] + 12)
                .attr("y", d => projection(d.geometry.coordinates)[1] + 4)
                .text(d => d.properties.name)
                .attr("class", "city-label")
                .style("opacity", 0);

            // UPDATE + MERGE
            nodesEnter.merge(nodes)
                .transition().duration(750)
                .attr("cx", d => projection(d.geometry.coordinates)[0])
                .attr("cy", d => projection(d.geometry.coordinates)[1])
                .attr("r", d => 3 + Math.sqrt(d.properties.score))
                .style("opacity", 1);

            labelsEnter.merge(labels)
                .transition().duration(750)
                .attr("x", d => projection(d.geometry.coordinates)[0] + 12)
                .attr("y", d => projection(d.geometry.coordinates)[1] + 4)
                .style("opacity", 1);
        }

        function filterEra(val) {
            const idx = parseInt(val);
            const eraName = eras[idx];
            const eraMap = { "Antiquity": 0, "Medieval": 1, "Renaissance": 2, "Enlightenment": 3 };

            const visible = allPlaces.filter(p => {
                const pEraIdx = eraMap[p.properties.era] ?? 0;
                return pEraIdx <= idx;
            });

            document.getElementById('era-label').innerText = idx === 3 ? "ALL ERAS" : `${eraName.toUpperCase()} & PRIOR`;
            renderMap(visible);
        }

        function openCity(props) {
            const drawer = document.getElementById('city-drawer');
            const content = document.getElementById('drawer-content');

            drawer.classList.add('open');
            content.innerHTML = `
                <div>
                    <div class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2">${props.region} ‚Ä¢ ${props.era}</div>
                    <h2 class="text-4xl font-black text-white serif mb-6">${props.name}</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div class="text-2xl font-bold text-emerald-400">${props.mentions}</div>
                            <div class="text-[9px] uppercase text-slate-500 font-bold">Corpus Mentions</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div class="text-2xl font-bold text-emerald-400">${props.score}</div>
                            <div class="text-[9px] uppercase text-slate-500 font-bold">Spirit Score</div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block">Associated Texts</label>
                        ${props.docs.length > 0 ? props.docs.map(d => `
                            <div onclick="window.location.href='library.html?doc=${d.id}'" class="p-4 bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-emerald-500/30 rounded-xl cursor-pointer transition group">
                                <div class="text-sm font-bold text-slate-200 group-hover:text-emerald-400 transition">${d.title}</div>
                                <div class="text-[10px] text-slate-500 mt-1">${d.year || props.era}</div>
                            </div>
                        `).join('') : '<div class="text-sm text-slate-600 italic">No specific texts linked heavily to this center.</div>'}
                    </div>
                </div>
            `;
        }

        function closeDrawer() {
            document.getElementById('city-drawer').classList.remove('open');
        }

        function zoomMap(factor) {
            svg.transition().duration(750).call(zoom.scaleBy, factor);
        }

        // Handle Window Resize
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            projection.translate([width / 2, height / 2]);
            renderMap(allPlaces); // Re-render positions
        });

        init();
    </script>
</body>

</html>